# Docker Compose for Clad Studio 2-validator testnet
#
# Two modes of operation:
#
# 1. Use pre-built image (RECOMMENDED - fast):
#    export CLAD_IMAGE=ghcr.io/clad-sovereign/clad-node:latest
#    podman-compose up -d
#
# 2. Build from source (slow, ~30-60 min):
#    podman-compose up -d --build
#
# Ports:
#   Alice: ws://localhost:9944, http://localhost:9933, metrics http://localhost:9615
#   Bob:   ws://localhost:9945, http://localhost:9934, metrics http://localhost:9616
#
# Connect Polkadot.js Apps: https://polkadot.js.org/apps/?rpc=ws://127.0.0.1:9944

services:
  alice:
    image: ${CLAD_IMAGE:-}
    build:
      context: .
      dockerfile: ${CLAD_DOCKERFILE:-Dockerfile}
    container_name: clad-alice
    ports:
      - "9944:9944"  # WebSocket RPC
      - "9933:9933"  # HTTP RPC
      - "30333:30333"  # P2P
      - "9615:9615"  # Prometheus metrics
    volumes:
      - alice-data:/clad-node/.local/share
    command: [
      "--alice",
      "--validator",
      "--base-path", "/clad-node/.local/share/alice",
      "--chain", "local",
      "--node-key", "0000000000000000000000000000000000000000000000000000000000000001",
      "--port", "30333",
      "--rpc-port", "9933",
      "--rpc-external",
      "--rpc-cors", "all",
      "--rpc-methods", "Safe",
      "--prometheus-external",
      "--prometheus-port", "9615"
    ]
    networks:
      - clad-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9933/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  bob:
    image: ${CLAD_IMAGE:-}
    build:
      context: .
      dockerfile: ${CLAD_DOCKERFILE:-Dockerfile}
    container_name: clad-bob
    ports:
      - "9945:9944"  # WebSocket RPC (different host port)
      - "9934:9933"  # HTTP RPC (different host port)
      - "30334:30333"  # P2P (different host port)
      - "9616:9615"  # Prometheus metrics (different host port)
    volumes:
      - bob-data:/clad-node/.local/share
    command: [
      "--bob",
      "--validator",
      "--base-path", "/clad-node/.local/share/bob",
      "--chain", "local",
      "--port", "30333",
      "--rpc-port", "9933",
      "--rpc-external",
      "--rpc-cors", "all",
      "--rpc-methods", "Safe",
      "--prometheus-external",
      "--prometheus-port", "9615",
      "--bootnodes", "/dns/alice/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp"
    ]
    depends_on:
      alice:
        condition: service_healthy
    networks:
      - clad-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9933/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  alice-data:
  bob-data:

networks:
  clad-network:
    driver: bridge
